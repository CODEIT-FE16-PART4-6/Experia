name: Bundle Size Analysis

on:
  pull_request:
    branches: [dev, main]
  push:
    branches: [dev, main]

jobs:
  bundle-size:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          ANALYZE: true

      - name: Analyze bundle size
        run: |
          echo "📊 번들 크기 분석 중..."

          # .next/static 폴더 크기 측정
          echo "📁 .next/static 폴더 크기:"
          du -sh .next/static || echo "static 폴더 없음"

          # 주요 JavaScript 청크 크기 측정
          echo "📄 JavaScript 청크 크기:"
          find .next/static/chunks -name "*.js" -exec ls -lh {} \; | head -10

          # CSS 파일 크기 측정
          echo "🎨 CSS 파일 크기:"
          find .next/static/css -name "*.css" -exec ls -lh {} \; | head -5

          # 전체 빌드 크기
          echo "📦 전체 빌드 크기:"
          du -sh .next

          # 상세 분석을 위한 JSON 파일 생성
          echo "📋 번들 분석 결과:"
          echo "{
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"branch\": \"${{ github.ref_name }}\",
            \"commit\": \"${{ github.sha }}\",
            \"build_size\": \"$(du -s .next | cut -f1)\",
            \"static_size\": \"$(du -s .next/static 2>/dev/null | cut -f1 || echo '0')\",
            \"chunks\": [
              $(find .next/static/chunks -name "*.js" -exec basename {} \; | head -5 | sed 's/.*/\"&\"/' | tr '\n' ',' | sed 's/,$//')
            ]
          }" > bundle-analysis.json

          cat bundle-analysis.json

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-${{ github.sha }}
          path: |
            bundle-analysis.json
            .next/static/
          retention-days: 30

      - name: Comment PR with bundle size
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const bundleData = JSON.parse(fs.readFileSync('bundle-analysis.json', 'utf8'));

            const buildSizeKB = Math.round(bundleData.build_size / 1024);
            const staticSizeKB = Math.round(bundleData.static_size / 1024);

            const comment = `## 📊 번들 크기 분석 결과

            ### 📦 빌드 크기
            - **전체 빌드**: ${buildSizeKB}KB
            - **정적 파일**: ${staticSizeKB}KB

            ### 📋 주요 청크
            ${bundleData.chunks.map(chunk => `- \`${chunk}\``).join('\n')}

            ### 📈 추천사항
            ${buildSizeKB > 5000 ? '⚠️ 빌드 크기가 큽니다. 코드 스플리팅을 고려해보세요.' : '✅ 빌드 크기가 적절합니다.'}

            ---
            *분석 시간: ${bundleData.timestamp}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
