name: Bundle Size Analysis

on:
  pull_request:
    branches: [dev, main]
  push:
    branches: [dev, main]

jobs:
  bundle-size:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          ANALYZE: true

      - name: Analyze bundle size
        run: |
          echo "ğŸ“Š ë²ˆë“¤ í¬ê¸° ë¶„ì„ ì¤‘..."

          # .next/static í´ë” í¬ê¸° ì¸¡ì •
          echo "ğŸ“ .next/static í´ë” í¬ê¸°:"
          du -sh .next/static || echo "static í´ë” ì—†ìŒ"

          # ì£¼ìš” JavaScript ì²­í¬ í¬ê¸° ì¸¡ì •
          echo "ğŸ“„ JavaScript ì²­í¬ í¬ê¸°:"
          find .next/static/chunks -name "*.js" -exec ls -lh {} \; | head -10

          # CSS íŒŒì¼ í¬ê¸° ì¸¡ì •
          echo "ğŸ¨ CSS íŒŒì¼ í¬ê¸°:"
          find .next/static/css -name "*.css" -exec ls -lh {} \; | head -5

          # ì „ì²´ ë¹Œë“œ í¬ê¸°
          echo "ğŸ“¦ ì „ì²´ ë¹Œë“œ í¬ê¸°:"
          du -sh .next

          # ìƒì„¸ ë¶„ì„ì„ ìœ„í•œ JSON íŒŒì¼ ìƒì„±
          echo "ğŸ“‹ ë²ˆë“¤ ë¶„ì„ ê²°ê³¼:"
          echo "{
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"branch\": \"${{ github.ref_name }}\",
            \"commit\": \"${{ github.sha }}\",
            \"build_size\": \"$(du -s .next | cut -f1)\",
            \"static_size\": \"$(du -s .next/static 2>/dev/null | cut -f1 || echo '0')\",
            \"chunks\": [
              $(find .next/static/chunks -name "*.js" -exec basename {} \; | head -5 | sed 's/.*/\"&\"/' | tr '\n' ',' | sed 's/,$//')
            ]
          }" > bundle-analysis.json

          cat bundle-analysis.json

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-${{ github.sha }}
          path: |
            bundle-analysis.json
            .next/static/
          retention-days: 30

      - name: Comment PR with bundle size
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const bundleData = JSON.parse(fs.readFileSync('bundle-analysis.json', 'utf8'));

            const buildSizeKB = Math.round(bundleData.build_size / 1024);
            const staticSizeKB = Math.round(bundleData.static_size / 1024);

            const comment = `## ğŸ“Š ë²ˆë“¤ í¬ê¸° ë¶„ì„ ê²°ê³¼

            ### ğŸ“¦ ë¹Œë“œ í¬ê¸°
            - **ì „ì²´ ë¹Œë“œ**: ${buildSizeKB}KB
            - **ì •ì  íŒŒì¼**: ${staticSizeKB}KB

            ### ğŸ“‹ ì£¼ìš” ì²­í¬
            ${bundleData.chunks.map(chunk => `- \`${chunk}\``).join('\n')}

            ### ğŸ“ˆ ì¶”ì²œì‚¬í•­
            ${buildSizeKB > 5000 ? 'âš ï¸ ë¹Œë“œ í¬ê¸°ê°€ í½ë‹ˆë‹¤. ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.' : 'âœ… ë¹Œë“œ í¬ê¸°ê°€ ì ì ˆí•©ë‹ˆë‹¤.'}

            ---
            *ë¶„ì„ ì‹œê°„: ${bundleData.timestamp}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
