name: Advanced Bundle Analysis

on:
  pull_request:
    branches: [dev, main]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install bundle analyzer
        run: npm install --save-dev @next/bundle-analyzer

      - name: Build with bundle analysis
        run: |
          echo "ğŸ” ë²ˆë“¤ ë¶„ì„ì„ ìœ„í•œ ë¹Œë“œ ì¤‘..."
          ANALYZE=true npm run build
        env:
          ANALYZE: true

      - name: Generate bundle report
        run: |
          echo "ğŸ“Š ë²ˆë“¤ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..."

          # ë²ˆë“¤ í¬ê¸° ì •ë³´ ìˆ˜ì§‘
          echo "{
            \"build_size_kb\": $(du -s .next | cut -f1),
            \"static_size_kb\": $(du -s .next/static 2>/dev/null | cut -f1 || echo 0),
            \"js_chunks\": $(find .next/static/chunks -name '*.js' -exec basename {} \; | wc -l),
            \"css_files\": $(find .next/static/css -name '*.css' -exec basename {} \; | wc -l),
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"commit\": \"${{ github.sha }}\",
            \"branch\": \"${{ github.ref_name }}\"
          }" > bundle-report.json

          # ìƒì„¸ íŒŒì¼ ëª©ë¡ ìƒì„±
          echo "ğŸ“ íŒŒì¼ë³„ í¬ê¸° ë¶„ì„:"
          find .next -type f -name "*.js" -o -name "*.css" -o -name "*.map" | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || echo 0)
            echo "$file:$size" >> file-sizes.txt
          done

          # í° íŒŒì¼ë“¤ TOP 10
          echo "ğŸ” í° íŒŒì¼ TOP 10:"
          sort -t: -k2 -nr file-sizes.txt | head -10 > top-files.txt

          cat bundle-report.json
          echo "---"
          cat top-files.txt

      - name: Compare with previous build
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ“ˆ ì´ì „ ë¹Œë“œì™€ ë¹„êµ ì¤‘..."

          # ê¸°ë³¸ê°’ ì„¤ì •
          PREV_SIZE=0
          CURRENT_SIZE=$(cat bundle-report.json | grep -o '"build_size_kb":[0-9]*' | cut -d: -f2)

          # GitHub APIë¡œ ì´ì „ ë¹Œë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ê°„ë‹¨í•œ ë²„ì „)
          echo "í˜„ì¬ ë¹Œë“œ í¬ê¸°: ${CURRENT_SIZE}KB"
          echo "ì´ì „ ë¹Œë“œ í¬ê¸°: ${PREV_SIZE}KB (ë¹„êµ ë¶ˆê°€)"

          # í¬ê¸° ë³€í™” ê³„ì‚°
          if [ $PREV_SIZE -gt 0 ]; then
            DIFF=$((CURRENT_SIZE - PREV_SIZE))
            PERCENT=$((DIFF * 100 / PREV_SIZE))
            echo "í¬ê¸° ë³€í™”: ${DIFF}KB (${PERCENT}%)"
          else
            echo "í¬ê¸° ë³€í™”: ì²« ë²ˆì§¸ ë¶„ì„"
          fi

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-${{ github.sha }}
          path: |
            bundle-report.json
            file-sizes.txt
            top-files.txt
          retention-days: 30

      - name: Create bundle size comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const report = JSON.parse(fs.readFileSync('bundle-report.json', 'utf8'));
              const topFiles = fs.readFileSync('top-files.txt', 'utf8');

              const buildSizeKB = Math.round(report.build_size_kb / 1024);
              const staticSizeKB = Math.round(report.static_size_kb / 1024);

              const topFilesList = topFiles.split('\n').slice(0, 5).map(file => {
                const [path, size] = file.split(':');
                const sizeKB = Math.round(parseInt(size) / 1024);
                return `- \`${path.replace('.next/', '')}\`: ${sizeKB}KB`;
              }).join('\n');

              const recommendations = [];

              if (buildSizeKB > 5000) {
                recommendations.push('âš ï¸ **ë¹Œë“œ í¬ê¸°ê°€ í½ë‹ˆë‹¤** - ì½”ë“œ ìŠ¤í”Œë¦¬íŒ… ê³ ë ¤');
              }
              if (report.js_chunks > 50) {
                recommendations.push('âš ï¸ **ì²­í¬ê°€ ë§ìŠµë‹ˆë‹¤** - ë²ˆë“¤ ìµœì í™” ê³ ë ¤');
              }
              if (recommendations.length === 0) {
                recommendations.push('âœ… **ë²ˆë“¤ í¬ê¸°ê°€ ì ì ˆí•©ë‹ˆë‹¤**');
              }

              const comment = `## ğŸ“Š ë²ˆë“¤ í¬ê¸° ë¶„ì„ ê²°ê³¼

              ### ğŸ“¦ ì „ì²´ í¬ê¸°
              - **ë¹Œë“œ í¬ê¸°**: ${buildSizeKB}KB
              - **ì •ì  íŒŒì¼**: ${staticSizeKB}KB
              - **JS ì²­í¬ ìˆ˜**: ${report.js_chunks}ê°œ
              - **CSS íŒŒì¼ ìˆ˜**: ${report.css_files}ê°œ

              ### ğŸ” í° íŒŒì¼ TOP 5
              ${topFilesList}

              ### ğŸ’¡ ì¶”ì²œì‚¬í•­
              ${recommendations.join('\n')}

              ---
              *ë¶„ì„ ì‹œê°„: ${report.timestamp}*`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });

            } catch (error) {
              console.log('ë²ˆë“¤ ë¶„ì„ ê²°ê³¼ ìƒì„± ì‹¤íŒ¨:', error.message);
            }
